---
import { siteConfig } from '../config.ts';
import { Icon } from 'astro-icon/components';
import { testimonialsContent } from '../content/testimonials';
---

<section 
  id="testimonials" 
  class="relative px-4 py-24 sm:px-6 lg:px-8 border-b-2 border-brand-charcoal overflow-hidden bg-white"
  style="background-image: linear-gradient(#eef0f7 2px, transparent 2px); background-size: 100% 40px;"
>
  <div class="absolute top-10 right-10 border-4 border-brand-mint text-brand-mint px-4 py-2 rounded-xl font-black uppercase tracking-widest -rotate-12 opacity-40 text-2xl hidden md:block">
    Verified Feedback
  </div>

  <div class="mx-auto max-w-7xl relative z-10">
    <div class="scroll-fade-up mx-auto mb-20 max-w-3xl text-center">
      <h2 class="text-brand-charcoal mb-6 text-4xl font-extrabold sm:text-5xl tracking-tight uppercase italic">
        <span class="relative inline-block">
          <span class="relative z-10 px-1">Tutor Success Stories.</span>
          <span class="absolute bottom-1 left-0 h-4 w-full bg-brand-mint/80 z-0"></span>
        </span>
      </h2>
      <p class="text-brand-charcoal/70 text-xl font-bold">
        Join the tutors who have reclaimed their independence.
      </p>
    </div>

    <div class="relative">
      <div 
        id="testimonials-track"
        class="flex overflow-x-auto snap-x snap-mandatory no-scrollbar -mx-4 px-4 pt-4 pb-12 
               md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-10 md:px-2 md:mx-0 md:overflow-visible"
      >
        {
          testimonialsContent.map((testimonial, index) => (
            <div
              class={`flex-none w-[85%] mr-6 snap-center md:w-auto md:mr-0 
              relative p-8 border-2 border-brand-charcoal rounded-2xl shadow-[8px_8px_0px_0px_rgba(45,52,70,1)] 
              transition-all hover:-translate-y-1 ${testimonial.color} ${index % 2 === 0 ? 'rotate-1' : '-rotate-1'}`}
            >
              <div class="absolute -top-4 -left-4 bg-white border-2 border-brand-charcoal p-2 rounded-lg shadow-[4px_4px_0px_0px_rgba(45,52,70,1)]">
                <Icon name="heroicons:chat-bubble-bottom-center-text" class="h-6 w-6 text-brand-charcoal" />
              </div>

              <p class="text-brand-charcoal text-lg font-bold leading-relaxed mb-8 italic">
                "{testimonial.content}"
              </p>

              <div class="flex items-center gap-4 mt-auto">
                <div class="flex h-12 w-12 items-center justify-center rounded-full border-2 border-brand-charcoal bg-white font-black text-brand-charcoal shadow-[2px_2px_0px_0px_rgba(45,52,70,1)]">
                  {testimonial.avatar}
                </div>
                <div>
                  <h4 class="font-black uppercase text-sm tracking-tight text-brand-charcoal">{testimonial.name}</h4>
                  <p class="text-xs font-bold text-brand-charcoal/60 uppercase">{testimonial.role}</p>
                </div>
              </div>
            </div>
          ))
        }
      </div>

      <div class="flex justify-center gap-2 mt-2 md:hidden">
        {testimonialsContent.map((_, i) => (
          <div 
            class="h-2 w-2 rounded-full bg-brand-charcoal/20 transition-colors duration-300" 
            data-testimonial-dot={i}
          ></div>
        ))}
      </div>
    </div>
  </div>
</section>

<style>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  .testimonial-dot-active { background-color: #2d3446 !important; }
</style>

<script>
  function initTestimonials() {
    const track = document.getElementById('testimonials-track');
    const dots = document.querySelectorAll('[data-testimonial-dot]');
    if (!track) return;

    // Start on middle card for mobile
    if (window.innerWidth < 768) {
      const cards = track.children;
      const middleIndex = Math.floor(cards.length / 2);
      const middleCard = cards[middleIndex];
      const scrollLeft = middleCard.offsetLeft - (window.innerWidth / 2) + (middleCard.offsetWidth / 2);
      track.scrollLeft = scrollLeft;
    }

    const updateDots = () => {
      const scrollPos = track.scrollLeft;
      const firstCard = track.querySelector('div');
      if (!firstCard) return;
      
      const cardWidth = firstCard.offsetWidth + 24; 
      const activeIndex = Math.round(scrollPos / cardWidth);

      dots.forEach((dot, i) => {
        if (i === activeIndex) {
          dot.classList.add('testimonial-dot-active');
        } else {
          dot.classList.remove('testimonial-dot-active');
        }
      });
    };

    track.addEventListener('scroll', updateDots);
    updateDots();
  }

  document.addEventListener('DOMContentLoaded', initTestimonials);
  document.addEventListener('astro:after-swap', initTestimonials);
</script>